<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Encrypted Voting — Demo (Zama fhEVM)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<style>
  /* ---------- Clean professional styles ---------- */
  :root{
    --bg:#071026; --panel:#0e1722; --muted:#9fb0c8; --accent:#6EE7B7; --accent2:#60A5FA;
    --glass: rgba(255,255,255,0.03);
    --card-radius:14px;
    --max-width:1100px;
    font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color-scheme: dark;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#041026 0%, #07112a 100%);color:#eaf2fb}
  a{color:var(--accent)}
  header{position:sticky;top:0;background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.4));backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,0.02);z-index:50}
  .nav{max-width:var(--max-width);margin:0 auto;padding:14px 20px;display:flex;align-items:center;gap:20px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#042023}
  .site-title{font-weight:700;font-size:16px}
  nav{margin-left:20px}
  nav a{margin-right:14px;color:var(--muted);text-decoration:none;font-weight:600}
  .nav-right{margin-left:auto;display:flex;gap:10px;align-items:center}
  .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;padding:8px 12px;border-radius:10px;color:#03181a;font-weight:700;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent);padding:8px 10px;border-radius:10px;cursor:pointer}
  .container{max-width:var(--max-width);margin:32px auto;padding:20px}
  .hero{display:grid;grid-template-columns:1fr 420px;gap:24px;align-items:center}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:22px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 40px rgba(2,6,23,0.6)}
  h1{margin:0;font-size:28px}
  p.lead{color:var(--muted);margin-top:10px;margin-bottom:0}
  .small{color:var(--muted);font-size:13px}
  .field{margin-top:14px}
  input[type=text]{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .row{display:flex;gap:10px;align-items:center}
  .events{margin-top:12px;background:rgba(255,255,255,0.015);padding:12px;border-radius:10px;max-height:260px;overflow:auto}
  .event{padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));font-size:14px}
  footer{margin-top:28px;padding:18px;text-align:center;color:var(--muted);font-size:14px}
  .muted{color:var(--muted)}
  .meta{display:flex;gap:8px;align-items:center}
  .status{font-weight:700;padding:6px 8px;border-radius:999px;font-size:13px}
  .pending{background:#fff4ce;color:#6a4b00}
  .success{background:#dff7ef;color:#065a45}
  @media(max-width:960px){ .hero{grid-template-columns:1fr} .nav{padding:12px} .nav-right{gap:6px} }
</style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand">
        <div class="logo">Z</div>
        <div>
          <div class="site-title">Zama FHEVM Examples</div>
          <div class="small">Privacy-first smart contracts</div>
        </div>
      </div>

      <nav>
        <a href="#home">Home</a>
        <a href="#voting">Voting</a>
        <a href="#wallet" id="navWallet">Wallet</a>
      </nav>

      <div class="nav-right">
        <div class="small muted" id="acct">Not connected</div>
        <button id="connectBtn" class="btn">Connect Wallet</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="home" class="hero">
      <div>
        <div class="panel">
          <h1>Private Voting, public trust</h1>
          <p class="lead">Build confidential dApps without moving users off-chain. Zama's fhEVM lets developers run encrypted computation so apps keep secrets while still using the security of EVM chains.</p>

          <div class="field">
            <h3 style="margin:0 0 8px 0">Why fhEVM matters</h3>
            <ul class="small muted">
              <li>Keep votes, bids and sensitive data encrypted while still processing them on-chain.</li>
              <li>Integrates with existing EVM chains — no migration required.</li>
              <li>Developer-friendly: write Solidity, use Zama tools for encryption.</li>
            </ul>
          </div>

        </div>
      </div>

      <aside>
        <div class="panel">
          <div class="meta"><div class="small muted">Network:</div><div id="netInfo" class="small muted">local</div></div>
          <div style="margin-top:12px">
            <div class="small muted">Quick actions</div>
            <div style="display:flex;gap:8px;margin-top:8px;">
              <button id="btnVoting" class="btn-ghost">Go to Voting</button>
              <button id="quickConnect" class="btn">Connect</button>
            </div>
          </div>
          <div style="margin-top:12px" class="small muted">Demo: Encrypted Voting example using placeholder ciphertext. Replace with Zama SDK output for real FHE flows.</div>
        </div>
      </aside>
    </section>

    <!-- Voting Section -->
    <section id="voting" style="margin-top:22px">
      <div class="panel">
        <h2 style="margin:0 0 6px 0">Voting (Demo)</h2>
        <div class="small muted">Deploy the example contract (or use our repo example) and paste address below.</div>

        <div class="field" style="margin-top:12px">
          <label class="small muted">Contract Address</label>
          <div class="row" style="margin-top:8px">
            <input id="contractAddress" type="text" placeholder="0xYourDeployedContractAddress" />
            <button id="saveAddr" class="btn">Save</button>
            <button id="loadAddr" class="btn-ghost">Load</button>
            <button id="copyAddrBtn" class="btn-ghost">Copy</button>
          </div>
        </div>

        <div class="field">
          <label class="small muted">Register & Submit</label>
          <div class="row" style="margin-top:8px">
            <button id="registerBtn" class="btn">Register</button>
            <input id="cipherInput" type="text" placeholder="Enter vote (demo) e.g. voteA" style="flex:1" />
            <button id="submitBtn" class="btn">Submit Encrypted Vote</button>
          </div>
          <div class="small muted" style="margin-top:8px">Note: This demo uses UTF-8 bytes as placeholder ciphertext. For production, use Zama SDK to generate real ciphertext bytes.</div>
        </div>

        <div class="field" style="margin-top:12px">
          <div class="row" style="align-items:center;justify-content:space-between">
            <div class="small muted">Transaction status: <span id="txStatus" class="muted">idle</span></div>
            <div class="right small muted">Owner = deployer</div>
          </div>

          <div id="events" class="events" aria-live="polite" style="margin-top:12px"></div>
        </div>

      </div>
    </section>

    <footer>
      <div class="panel" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-weight:700">Built with Zama's fhEVM</div>
          <div class="small muted">Fully Homomorphic Encryption enabling private computation on public blockchains — privacy without migration.</div>
        </div>
        <div class="small muted">© <span id="year"></span> • Zama • fhEVM</div>
      </div>
    </footer>
  </main>

  <!-- Robust ethers loader + app bootstrap -->
  <script>
  (async function(){
    const CDNS = [
      "https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.min.js",
      "https://unpkg.com/ethers@6.9.0/dist/ethers.umd.min.js",
      "https://cdn.jsdelivr.net/gh/ethers-io/ethers.js@v6.9.0/dist/ethers.min.js"
    ];

    async function loadFrom(src){
      return new Promise((resolve, reject)=>{
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = () => resolve(true);
        s.onerror = () => reject(new Error('load failed ' + src));
        document.head.appendChild(s);
      });
    }

    let ok=false;
    for(const u of CDNS){
      try{
        await loadFrom(u);
        if (window.ethers){ ok=true; break; }
      }catch(e){ console.warn('CDN failed', u, e); }
    }
    if(!ok){
      alert('Failed to load web3 lib (ethers). Check network or open console for errors.');
      console.error('Could not load ethers from CDNs.');
      return;
    }

    // small wait to ensure ethers global ready
    await new Promise(r=>setTimeout(r,60));

    (function runApp(){
      // UI refs
      const connectBtn = document.getElementById('connectBtn');
      const quickConnect = document.getElementById('quickConnect');
      const btnVoting = document.getElementById('btnVoting');
      const acctEl = document.getElementById('acct');
      const netInfo = document.getElementById('netInfo');
      const contractInput = document.getElementById('contractAddress');
      const saveAddr = document.getElementById('saveAddr');
      const loadAddr = document.getElementById('loadAddr');
      const copyAddrBtn = document.getElementById('copyAddrBtn');
      const registerBtn = document.getElementById('registerBtn');
      const submitBtn = document.getElementById('submitBtn');
      const cipherInput = document.getElementById('cipherInput');
      const txStatus = document.getElementById('txStatus');
      const eventsEl = document.getElementById('events');

      let provider, signer, contract;
      const ABI = [
        "function register() public",
        "function submitEncryptedVote(bytes calldata) public",
        "event VoteSubmitted(address indexed voter)",
        "event TallyPublished(bytes ciphertextTally)"
      ];

      // helpers
      function logEvent(t){ const el=document.createElement('div'); el.className='event'; el.innerHTML=`<div style="font-weight:700">${String(t).replaceAll('<','&lt;')}</div>`; eventsEl.prepend(el); }
      function setAcct(a){ acctEl.textContent = a ? `${a.slice(0,6)}…${a.slice(-4)}` : 'Not connected'; }
      function setNet(n){ netInfo.textContent = n || 'unknown'; }
      function setTx(s){ txStatus.textContent = s; }

      // nav scroll
      btnVoting.addEventListener('click', ()=>{ document.getElementById('voting').scrollIntoView({behavior:'smooth'}); });

      // connect logic
      async function connectWallet(){
        if(!window.ethereum){ alert('MetaMask not found. Install a wallet.'); return; }
        try{
          provider = new window.ethers.BrowserProvider(window.ethereum,'any');
          await provider.send('eth_requestAccounts', []);
          signer = await provider.getSigner();
          const addr = await signer.getAddress();
          setAcct(addr);
          const net = await provider.getNetwork();
          setNet(`${net.name} (${net.chainId})`);
          logEvent('Wallet connected: ' + addr);
          // auto load saved contract if any
          const saved = localStorage.getItem('fhe_contract');
          if(saved) { contractInput.value = saved; await loadContract(saved); }
        }catch(e){
          console.error('connect failed', e);
          alert('Wallet connect failed: ' + (e?.message || e));
        }
      }
      connectBtn.addEventListener('click', connectWallet);
      quickConnect.addEventListener('click', connectWallet);

      // save/load contract
      saveAddr.addEventListener('click', ()=>{
        const v = contractInput.value.trim();
        if(!v) return alert('Paste contract address');
        localStorage.setItem('fhe_contract', v);
        logEvent('Saved contract: ' + v);
        loadContract(v);
      });
      loadAddr.addEventListener('click', ()=>{ const s = localStorage.getItem('fhe_contract'); if(!s) return alert('No saved contract'); contractInput.value = s; loadContract(s); });
      copyAddrBtn.addEventListener('click', ()=>{ const v = contractInput.value.trim(); if(!v) return alert('No address'); navigator.clipboard.writeText(v).then(()=>logEvent('Copied address')); });

      async function loadContract(addr){
        try{
          if(!window.ethers.isAddress(addr)){ alert('Invalid contract address'); return; }
          contract = new window.ethers.Contract(addr, ABI, provider || signer);
          logEvent('Loaded contract: '+addr);
          // subscribe events
          if(contract.on){
            contract.on('VoteSubmitted', (v)=>{ logEvent('Event VoteSubmitted by '+v); });
            contract.on('TallyPublished', (c)=>{ let r; try{ r = window.ethers.toUtf8String(c); } catch(e){ r = window.ethers.hexlify(c).slice(0,60) + '...'; } logEvent('Event TallyPublished — '+r); });
          }
        }catch(e){ console.error('loadContract error', e); alert('Load contract failed: '+(e?.message||e)); }
      }

      registerBtn.addEventListener('click', async ()=>{
        if(!signer) return alert('Connect wallet first');
        if(!contract) return alert('Load contract first (paste & Save)');
        try{
          setTx('Sending register tx...');
          const tx = await contract.connect(signer).register();
          logEvent('Register tx sent: ' + tx.hash);
          setTx('Pending: ' + tx.hash);
          const receipt = await tx.wait();
          setTx('Mined: ' + receipt.transactionHash);
          logEvent('Register confirmed');
        }catch(e){ console.error(e); setTx('Error'); logEvent('Register failed: '+(e?.message||e)); }
      });

      submitBtn.addEventListener('click', async ()=>{
        if(!signer) return alert('Connect wallet first');
        if(!contract) return alert('Load contract first (paste & Save)');
        try{
          const t = cipherInput.value.trim() || 'voteA';
          const bytes = window.ethers.toUtf8Bytes(t);
          setTx('Sending submit tx...');
          const tx = await contract.connect(signer).submitEncryptedVote(bytes);
          logEvent('Submit tx sent: ' + tx.hash);
          setTx('Pending: ' + tx.hash);
          const receipt = await tx.wait();
          setTx('Mined: ' + receipt.transactionHash);
          logEvent('Submit confirmed: ' + receipt.transactionHash);
        }catch(e){ console.error(e); setTx('Error'); logEvent('Submit failed: ' + (e?.message||e)); }
      });

      // on load: set year and load saved contract if any (readonly)
      document.getElementById('year').textContent = new Date().getFullYear();
      const saved = localStorage.getItem('fhe_contract') || '';
      if(saved) contractInput.value = saved;
      if(saved && window.ethereum){
        provider = new window.ethers.BrowserProvider(window.ethereum);
        provider.getNetwork().then(n=> setNet(`${n.name} (${n.chainId})`)).catch(()=>{});
        loadContract(saved).catch(()=>{});
      }

    })(); // runApp
  })(); // loader
  </script>
</body>
</html>

