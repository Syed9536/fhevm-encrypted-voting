<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Encrypted Voting — Demo</title>

  <!-- professional, minimal CSS -->
  <style>
    :root{
      --bg: #0b1220;
      --panel: #0f1724;
      --muted: #9fb0c8;
      --accent: #6ee7b7;
      --accent-2: #60a5fa;
      --glass: rgba(255,255,255,0.03);
      --card-radius: 14px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color-scheme: dark;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#041026 0%, #071029 100%);color:#e6eef6}
    .container{max-width:1100px;margin:36px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px}
    .brand{display:flex;flex-direction:column}
    h1{margin:0;font-size:22px;letter-spacing:-0.3px}
    .tag{color:var(--muted);font-size:13px;margin-top:6px}
    .panel{background:linear-gradient(180deg,var(--panel), rgba(3,6,11,0.4));border-radius:var(--card-radius);padding:22px;margin-top:18px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .col{flex:1;min-width:280px}
    label{display:block;color:var(--muted);font-size:13px;margin-bottom:8px}
    input[type=text]{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:#e6eef6;outline:none}
    button{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;padding:10px 14px;border-radius:10px;color:#021018;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(30,80,120,0.12)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent);padding:9px 12px;border-radius:10px}
    .muted{color:var(--muted);font-size:13px}
    .card-right{width:360px}
    .status{font-size:13px;padding:6px 10px;border-radius:999px;font-weight:700;display:inline-block}
    .pending{background:#fff6d8;color:#6a4b00}
    .success{background:#d6f6e9;color:#064e3b}
    .error{background:#ffd6d6;color:#6a1a1a}
    .events{margin-top:12px;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;max-height:260px;overflow:auto}
    .event{padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));font-size:14px}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    @media(max-width:900px){ .card-right{width:100%} .row{flex-direction:column} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <h1>Encrypted Voting — Demo</h1>
        <div class="tag">Zama FHEVM example • placeholder ciphertext for demo • replace with real ciphertext using Zama SDK</div>
      </div>

      <div class="row">
        <div id="acct" class="muted">Not connected</div>
        <button id="connectBtn">Connect Wallet</button>
      </div>
    </header>

    <div class="panel">
      <div class="row" style="align-items:flex-start">
        <div class="col">
          <label>Contract address (paste after deploy)</label>
          <input id="contractAddress" type="text" placeholder="0xYourDeployedContractAddress" />
          <div style="display:flex;gap:10px;margin-top:10px">
            <button id="saveAddr" class="btn-ghost">Save Address</button>
            <button id="loadAddr" class="btn-ghost">Load Saved</button>
            <div style="margin-left:auto" class="muted">Owner = deployer (for tally)</div>
          </div>

          <hr style="border:none;height:1px;background:rgba(255,255,255,0.03);margin:18px 0"/>

          <label>Submit encrypted vote (demo)</label>
          <div class="row" style="margin-bottom:6px">
            <input id="cipherInput" type="text" placeholder="Type fake ciphertext e.g. voteA" />
            <button id="submitBtn">Submit Encrypted Vote</button>
          </div>
          <div class="row" style="margin-bottom:8px">
            <button id="registerBtn" class="btn-ghost">Register</button>
            <div class="muted">Tip: Replace with SDK ciphertext for true FHE.</div>
          </div>
        </div>

        <div class="card-right">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <label>Tx Status</label>
              <div id="txStatus" class="muted">Idle</div>
            </div>
            <div style="text-align:right">
              <label>Network</label>
              <div id="netInfo" class="muted">unknown</div>
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Event feed</label>
            <div id="events" class="events"></div>
          </div>

          <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
            <div style="flex:1">
              <label class="muted">Quick actions</label>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="copyAddrBtn" class="btn-ghost">Copy Address</button>
                <button id="clearBtn" class="btn-ghost">Clear Events</button>
              </div>
            </div>
          </div>

        </div>
      </div>

      <footer>
        <div class="muted">Use Sepolia/testnet for a public demo. After you deploy contract, paste address & Save → connect MetaMask (Sepolia) → Register → Submit Vote.</div>
      </footer>
    </div>
  </div>

  <!-- ethers v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.min.js"></script>

  <script>
  // ---------- CONFIG (edit if you want a default address) ----------
  let DEFAULT_CONTRACT = ""; // paste deployed address here if you have it
  const ABI = [
    "function register() public",
    "function submitEncryptedVote(bytes calldata) public",
    "event VoteSubmitted(address indexed voter)",
    "event TallyPublished(bytes ciphertextTally)"
  ];
  // -----------------------------------------------------------------

  // UI elements
  const connectBtn = document.getElementById('connectBtn');
  const acctEl = document.getElementById('acct');
  const contractInput = document.getElementById('contractAddress');
  const saveAddr = document.getElementById('saveAddr');
  const loadAddr = document.getElementById('loadAddr');
  const registerBtn = document.getElementById('registerBtn');
  const submitBtn = document.getElementById('submitBtn');
  const cipherInput = document.getElementById('cipherInput');
  const txStatus = document.getElementById('txStatus');
  const eventsEl = document.getElementById('events');
  const netInfo = document.getElementById('netInfo');
  const copyAddrBtn = document.getElementById('copyAddrBtn');
  const clearBtn = document.getElementById('clearBtn');

  let provider, signer, contract;

  function logEvent(text, severity = 'info') {
    const el = document.createElement('div');
    el.className = 'event';
    el.innerHTML = `<div style="font-weight:700">${escapeHtml(text)}</div>`;
    eventsEl.prepend(el);
  }

  function escapeHtml(t){ return String(t).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // Wallet connect
  connectBtn.addEventListener('click', async () => {
    if (!window.ethereum) {
      alert('MetaMask not found. Please install a web3 wallet.');
      return;
    }
    try {
      provider = new ethers.BrowserProvider(window.ethereum, "any");
      await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      const addr = await signer.getAddress();
      acctEl.textContent = `${addr.slice(0,6)}…${addr.slice(-4)}`;
      const network = await provider.getNetwork();
      netInfo.textContent = `${network.name} (${network.chainId})`;
      logEvent('Wallet connected: ' + addr);
      // If contract already set, load it
      if (contractInput.value.trim()) await loadContract(contractInput.value.trim());
    } catch (err) {
      console.error(err);
      alert('Wallet connect failed: ' + err.message);
    }
  });

  // Save / load contract
  saveAddr.addEventListener('click', () => {
    const v = contractInput.value.trim();
    if (!v) return alert('Paste the contract address first');
    localStorage.setItem('fhe_contract', v);
    logEvent('Contract address saved locally: ' + v);
    loadContract(v);
  });

  loadAddr.addEventListener('click', () => {
    const saved = localStorage.getItem('fhe_contract') || DEFAULT_CONTRACT;
    if (!saved) return alert('No saved address found');
    contractInput.value = saved;
    loadContract(saved);
  });

  copyAddrBtn.addEventListener('click', () => {
    const v = contractInput.value.trim();
    if (!v) return alert('No address to copy');
    navigator.clipboard.writeText(v).then(()=>logEvent('Contract address copied'));
  });

  clearBtn.addEventListener('click', () => { eventsEl.innerHTML=''; logEvent('Events cleared'); });

  // Load contract helper
  async function loadContract(addr) {
    if (!addr) throw new Error('No address provided');
    if (!ethers.isAddress(addr)) { alert('Invalid contract address'); return; }
    contract = new ethers.Contract(addr, ABI, provider || signer);
    logEvent('Loaded contract: ' + addr);
    subscribeEvents();
  }

  // Register
  registerBtn.addEventListener('click', async () => {
    if (!signer) return alert('Connect wallet first');
    if (!contract) return alert('Load contract first (paste & Save)');
    try {
      txStatus.textContent = 'Sending register tx...';
      const tx = await contract.connect(signer).register();
      logEvent('Register tx sent: ' + tx.hash);
      txStatus.innerHTML = `<span class="status pending">Pending</span> ${tx.hash}`;
      const receipt = await tx.wait();
      txStatus.innerHTML = `<span class="status success">Mined</span> ${receipt.transactionHash}`;
      logEvent('Register confirmed: ' + receipt.transactionHash);
    } catch (err) {
      console.error(err);
      txStatus.textContent = 'Error';
      logEvent('Register failed: ' + (err?.message || err));
    }
  });

  // Submit encrypted vote
  submitBtn.addEventListener('click', async () => {
    if (!signer) return alert('Connect wallet first');
    if (!contract) return alert('Load contract first (paste & Save)');
    try {
      const text = cipherInput.value.trim() || 'voteA';
      const bytes = ethers.toUtf8Bytes(text);
      txStatus.textContent = 'Sending submit tx...';
      const tx = await contract.connect(signer).submitEncryptedVote(bytes);
      logEvent('Submit tx sent: ' + tx.hash);
      txStatus.innerHTML = `<span class="status pending">Pending</span> ${tx.hash}`;
      const receipt = await tx.wait();
      txStatus.innerHTML = `<span class="status success">Mined</span> ${receipt.transactionHash}`;
      logEvent('Submit confirmed: ' + receipt.transactionHash);
    } catch (err) {
      console.error(err);
      txStatus.textContent = 'Error';
      logEvent('Submit failed: ' + (err?.message || err));
    }
  });

  // Subscribe to events
  function subscribeEvents() {
    if (!contract) return;
    try {
      contract.on('VoteSubmitted', (voter) => {
        logEvent('Event: VoteSubmitted by ' + voter);
      });
      contract.on('TallyPublished', (cipher) => {
        // cipher may be bytes; show truncated hex or utf8 attempt
        let repr;
        try { repr = ethers.toUtf8String(cipher); } catch(e) { repr = ethers.hexlify(cipher).slice(0,60) + '...'; }
        logEvent('Event: TallyPublished — ' + repr);
      });
      logEvent('Event listeners attached');
    } catch (err) {
      console.warn('subscribeEvents failed', err);
    }
  }

  // On load: try load saved address or default
  window.addEventListener('load', () => {
    const saved = localStorage.getItem('fhe_contract') || DEFAULT_CONTRACT;
    if (saved) contractInput.value = saved;
    if (saved && window.ethereum) {
      // auto connect provider as readonly
      provider = new ethers.BrowserProvider(window.ethereum);
      provider.getNetwork().then(n => netInfo.textContent = `${n.name} (${n.chainId})`).catch(()=>{});
      // try to load contract in readonly mode
      loadContract(saved).catch(()=>{/*no-op*/});
    }
  });

  // small helper: validate Ethereum address
  const ethersAddressRegex = /^0x[0-9a-fA-F]{40}$/;

  </script>
</body>
</html>

